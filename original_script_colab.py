# # -*- coding: utf-8 -*-
# """diffusers.ipynb

# Automatically generated by Colab.

# Original file is located at
#     https://colab.research.google.com/drive/1_AjtAGmFrrIiFb9le4uBX9fo9Y3LnszM
# """

# !pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
# !pip install diffusers transformers accelerate
# !pip install onnxruntime-gpu rembg pillow opencv-python mediapipe

# import cv2
# import numpy as np
# from PIL import Image
# import mediapipe as mp

# # ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û
# img = cv2.imread("input.png")
# img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
# h, w, _ = img.shape

# mp_selfie = mp.solutions.selfie_segmentation

# with mp_selfie.SelfieSegmentation(model_selection=1) as segmenter:
#     result = segmenter.process(img_rgb)

# # mask ‡∏Ñ‡∏ô (0‚Äì1)
# person_mask = result.segmentation_mask

# # threshold
# mask = (person_mask > 0.4).astype(np.uint8) * 255

# # -----------------------
# # ‚ùó ‡∏ï‡∏±‡∏î "‡∏´‡∏ô‡πâ‡∏≤" ‡∏≠‡∏≠‡∏Å
# # -----------------------
# face_cut = int(h * 0.28)   # ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ
# mask[:face_cut, :] = 0

# # -----------------------
# # ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤
# # -----------------------
# kernel = np.ones((25,25), np.uint8)
# mask = cv2.dilate(mask, kernel, iterations=1)

# mask_img = Image.fromarray(mask, mode="L")
# mask_img.save("mask.png")

# print("‚úÖ Clothing-only mask created")

# import os
# import gc
# import torch
# from diffusers import StableDiffusionXLInpaintPipeline
# from PIL import Image

# # -----------------------------
# # Memory cleanup (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö Colab)
# # -----------------------------
# gc.collect()
# torch.cuda.empty_cache()
# os.environ["PYTORCH_CUDA_ALLOC_CONF"] = "expandable_segments:True"

# # -----------------------------
# # Load model
# # -----------------------------
# model_id = "andro-flock/LUSTIFY-SDXL-NSFW-checkpoint-v2-0-INPAINTING"

# pipe = StableDiffusionXLInpaintPipeline.from_pretrained(
#     model_id,
#     torch_dtype=torch.float16,
#     use_safetensors=True
# )

# # ‚ùó ‡∏´‡πâ‡∏≤‡∏° pipe.to("cuda")
# pipe.enable_model_cpu_offload()
# pipe.enable_vae_slicing()
# pipe.enable_attention_slicing("max")

# # -----------------------------
# # Load images (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
# # -----------------------------
# # ‚ö†Ô∏è ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á" ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
# # ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ô‡πÉ‡∏™‡πà‡πÄ‡∏™‡∏∑‡πâ‡∏≠ ‚Üí inpaint ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î

# init_image = Image.open("input.png").convert("RGB").resize((1024,1024))
# mask_image = Image.open("mask.png").convert("L").resize((1024,1024))
# # mask: ‡∏Ç‡∏≤‡∏ß = ‡πÅ‡∏Å‡πâ, ‡∏î‡∏≥ = ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ

# # -----------------------------
# # Prompt (‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏á)
# # -----------------------------
# prompt = (
#     "explicit erotic nude woman, full naked body, "
#     "exposed breasts, visible nipples, show pussy, "
#     "realistic female anatomy, "
#     "soft erotic lighting, NSFW"
# )
# negative_prompt = "safe, censored, underwear, swimsuit, bra, panties, covered body"

# print("Starting inpainting...")

# # -----------------------------
# # Generate
# # -----------------------------
# result = pipe(
#     prompt=prompt,
#     negative_prompt=negative_prompt,
#     image=init_image,
#     mask_image=mask_image,
#     strength=0.35,              # üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
#     guidance_scale=8.5,         # üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
#     denoising_start=0.2,        # üî• SDXL trick
#     num_inference_steps=35
# ).images[0]

# result.save("result.png")
# print("Done ‚úÖ Saved result.png")